#!/bin/bash

### AEM
# Displays an overview of all running AEM instances
function cqi(){
     
    if [ "$(ps aux | grep [c]q)" ]
        then
             
            count=0;
            echo ""
            ps aux -wwE | grep [c]q | while read -r line ; do
             
                ((count++));
                params=($line);
                 
                username=(${params[0]});
                pid=(${params[1]});
                port="not found";
                debugPort="not found";
                runmodes="not found";
                path="not found";
                 
                portRegex="-p ([0-9]+)";
                debugPortRegex="address=([0-9]+)";
                runmodesRegex="-Dsling.run.modes=([^[:space:]]+)";
                pathRegex="PWD=([^[:space:]]+)";
                 
                [[ $line =~ $portRegex ]] && port="${BASH_REMATCH[1]}";
                [[ $line =~ $runmodesRegex ]] && runmodes="${BASH_REMATCH[1]}";
                [[ $line =~ $debugPortRegex ]] && debugPort="${BASH_REMATCH[1]}";
                [[ $line =~ $pathRegex ]] && path="${BASH_REMATCH[1]}";
                echo "----------------------";
                echo "AEM Instance" $count;
                echo "----------------------";
                echo "username:  "$username;
                echo "pid:       "$pid;
                echo "port:      "$port;
                echo "debugPort: "$debugPort;
                echo "runmodes:  "$runmodes;
                echo "path:      "$path;
                echo "----------------------";
                echo "";
            done
             
        else
            echo "";
            echo "No running AEM instances found";
            echo "";
        fi
}
alias aemi=cqi

# Color CQ-Log
function cqlog() {
    tail -fn 128 "$@" | awk '
    /SEVERE/ {print "\033[35m" $0 "\033[39m"}
    /ERROR/ {print "\033[31m" $0 "\033[39m"}
    /WARN/ {print "\033[33m" $0 "\033[39m"}
    /DEBUG/ {print "\033[30m" $0 "\033[39m"}
    !/SEVERE|ERROR|WARN|DEBUG/ {print $0 }
';}

# Death to all CQ instances!
function killcq() {
    kill $(ps aux | grep '[c]rx-quickstart' | awk '{print $2}')
}
 
# CQ, Y U NO DIE?
function KILLCQ() {
    killcq -9
}

AUTHOR_PATH=/opt/aem/author
alias astop='$AUTHOR_PATH/crx-quickstart/bin/stop'
alias astart='$AUTHOR_PATH/crx-quickstart/bin/start'
alias astatus='$AUTHOR_PATH/crx-quickstart/bin/status'
alias alog='tail -f -n 1000 $AUTHOR_PATH/crx-quickstart/logs/error.log'

PUBLISH_PATH=/opt/aem/publish1
alias pstop='$PUBLISH_PATH/crx-quickstart/bin/stop'
alias pstart='$PUBLISH_PATH/crx-quickstart/bin/start'
alias pstatus='$PUBLISH_PATH/crx-quickstart/bin/status'
alias plog='tail -f -n 1000 $PUBLISH_PATH/crx-quickstart/logs/error.log'
